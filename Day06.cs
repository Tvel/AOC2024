using System.Diagnostics;

namespace AOC2024;

public class Day06
{
    [Theory]
    [InlineData(Inputs.Sample, 41)]
    [InlineData(Inputs.Input, 5409)]
    public void Part1(string inputString, long expected)
    {
        char[][] map = inputString.Split(Environment.NewLine).Select(x => x.ToCharArray()).ToArray();
        (int x, int y)[] directions =
        [
            (-1, 0), //up
            (0, 1), //right
            (1, 0), //down
            (0, -1), //left
        ];

        (int x, int y, int directionIndex) guard = (-1, -1, 0);
        for (int x = 0; x < map.Length; x++)
        {
            char[] row = map[x];
            int y = row.AsSpan().IndexOf('^');
            if (y is -1) continue;
            guard = (x, y, 0);
            row[y] = 'X';
            break;
        }

        bool walk = true;
        while (walk)
        {
            //check if we can walk forward
            int newX = guard.x + directions[guard.directionIndex].x;
            int newY = guard.y + directions[guard.directionIndex].y;
            if (newX < 0 || newY < 0 || newX >= map.Length || newY >= map[0].Length)
            {
                walk = false;
                break;
            }

            //check if we have to turn right
            if (map[newX][newY] is '#')
            {
                guard.directionIndex = (guard.directionIndex + 1) % directions.Length;
            }
            else
            {
                map[newX][newY] = 'X';
                guard = (newX, newY, guard.directionIndex);
            }
        }

        int result = map.Sum(x => x.Count(y => y is 'X'));

        Assert.Equal(expected, result);
    }

    [Theory]
    [InlineData(Inputs.Sample, 6)]
    public void Part2Wrong(string inputString, long expected)
    {
        char[][] map = inputString.Split(Environment.NewLine).Select(x => x.ToCharArray()).ToArray();
        (int x, int y)[] directions =
        [
            (-1, 0), //up
            (0, 1), //right
            (1, 0), //down
            (0, -1), //left
        ];

        (int x, int y, int directionIndex) guard = (-1, -1, 0);
        for (int x = 0; x < map.Length; x++)
        {
            char[] row = map[x];
            int y = row.AsSpan().IndexOf('^');
            if (y is -1) continue;
            guard = (x, y, 0);
            row[y] = '.';
            break;
        }

        bool walk = true;
        List<(int x, int y, int directionIndex)> turningPoints = [];
        while (walk)
        {
            //check if we can walk forward
            int newX = guard.x + directions[guard.directionIndex].x;
            int newY = guard.y + directions[guard.directionIndex].y;
            if (newX < 0 || newY < 0 || newX >= map.Length || newY >= map[0].Length)
            {
                walk = false;
                break;
            }

            //check if we have to turn right
            if (map[newX][newY] is '#')
            {
                guard.directionIndex = (guard.directionIndex + 1) % directions.Length;
                turningPoints.Add(guard);
            }
            else
            {
                map[newX][newY] = 'X';
                guard = (newX, newY, guard.directionIndex);
            }
        }

        //check if we can loop
        int result = 0;
        for (int pointIndex = 2; pointIndex < turningPoints.Count; pointIndex++)
        {
            var first = turningPoints[pointIndex - 2];
            var third = turningPoints[pointIndex];

            (int x, int y) fourth = third.directionIndex switch
            {
                0 or 2 => (first.x, third.y),
                1 or 3 => (third.x, first.y),
                _ => throw new UnreachableException("on no!")
            };

            (int x, int y)[] toCheck1;
            {
                var a = Math.Min(fourth.x, first.x) - Math.Max(fourth.x, first.x);
                var ax = Enumerable.Range(a, Math.Clamp(Math.Abs(a) - 1, 0, 10)).ToArray();
                var b = Math.Min(fourth.y, first.y) - Math.Max(fourth.y, first.y);
                var by = Enumerable.Range(b, Math.Clamp(Math.Abs(b) - 1, 0, 10)).ToArray();
                if (ax.Length == 0) ax = Enumerable.Repeat(0, by.Length).ToArray();
                if (by.Length == 0) by = Enumerable.Repeat(0, ax.Length).ToArray();
                toCheck1 = ax.Zip(by).ToArray();
            }

            (int x, int y)[] toCheck2;
            {
                var aa = Math.Min(fourth.x, third.x) - Math.Max(fourth.x, third.x);
                var aax = Enumerable.Range(aa, Math.Clamp(Math.Abs(aa) - 1, 0, 10)).ToArray();
                var ab = Math.Min(fourth.y, third.y) - Math.Max(fourth.y, third.y);
                var aby = Enumerable.Range(ab, Math.Clamp(Math.Abs(ab) - 1, 0, 10)).ToArray();
                if (aax.Length == 0) aax = Enumerable.Repeat(0, aby.Length).ToArray();
                if (aby.Length == 0) aby = Enumerable.Repeat(0, aax.Length).ToArray();
                toCheck2 = aax.Zip(aby).ToArray();
            }

            bool ok1 = true;
            (int x, int y) start1 = (Math.Max(fourth.x, first.x), Math.Max(fourth.y, first.y));
            foreach (var (mx, my) in toCheck1)
            {
                int x = start1.x + mx;
                int y = start1.y + my;
                if (map[x][y] is '#')
                {
                    ok1 = false;
                    break;
                }
            }

            bool ok2 = true;
            (int x, int y) start2 = (Math.Max(fourth.x, third.x), Math.Max(fourth.y, third.y));
            foreach (var (mx, my) in toCheck2)
            {
                int x = start2.x + mx;
                int y = start2.y + my;
                if (map[x][y] is '#')
                {
                    ok1 = false;
                    break;
                }
            }

            if (ok1 && ok2) result++;
        }

        Assert.Equal(expected, result);
    }
}

file class Inputs
{
    public const string Sample =
        """
        ....#.....
        .........#
        ..........
        ..#.......
        .......#..
        ..........
        .#..^.....
        ........#.
        #.........
        ......#...
        """;
    //  0123456789
    public const string Input =
        """
        ..#.........#...#......#...........#.#...#............#...#.........#....#......................#......#..........................
        ...........#....#.............#.....................................#............................................#.....#..........
        .................#.........#.......#.......#..#............#.........#.........#............................................#.....
        ......#................................#.........................................#................................................
        #...............................##......#.#...........................#....................#...#...............#.................#
        .............#......#...........................................#..............#..........#..............#........................
        ...#...................#..............#........#.......#..........#.........................#.#.....#.....#.......................
        #.#...#.............................#.................................................#..............#............#...............
        .............................#.......#.............#......#...............#.....#.................................................
        ....................................#.....................................#.................#........#..........#.#..#...........#
        ......................#......#...............................#.................#.......#......................#.......#...........
        ...#..............#....................#............#...........##..#.....................................................#.......
        ....#.........#...................................#................................................#..........................#...
        ..............#.....#.................................................................#..#.....##.......#.........................
        .........#....#...........##..........................................#......#.....................#..........#.......#...........
        ..#....#..........#.................................................................#....#............#............#........#.....
        ............#.#....#...........#.............#...........#..................#.....#.................................#.......#.....
        ..........#.......#............................#........#...........#.......#...#....#........#.............##.#............#.....
        ...................#.........#....#.....................................................................#.#..........#............
        .#...#.#..................#...............................................#...........................#......................#....
        .........#..............#.........#.......#.#......##..................#......#...#..#...........#.....................#..........
        ...............................#.............#..#......#............#..........#......................#..........#.............#..
        ..........#.....#..........................#..................................................#.#..#.....#........................
        ............#..##.................................#....................#.....#.......................................#............
        ......................#.#...................#......#..............................................................#...............
        .......#.............................................................................#............................................
        ........#.................#....................................................#.......................................#....##.#..
        ..................#........................#......#..##....#.........#...##..#....................................#...............
        .............#..............................................................................##...#......#.................#.......
        ..................................#.#.............................................................................#...............
        ...........#.................................#.......................................................................#......#.....
        .....#............................................................#................................................#..............
        .....#...........#.#..........#..............#..........................#.................................................#.......
        ....#........#...#..........#..#..........................................................................#.......................
        .........................................................................#.....#.......................................#....#.....
        ...............#...#..#.....#.......................#.................#........#..........##....................................#.
        .......................#....#...#..................#..................#.....................................#.............#.......
        ...........#..#...#..............................................^........#........................#......................#.......
        .............................................#.................................................................................#..
        ......#...#.........#.....................................#...............................................#..#....#.......#.......
        ...#......................................................#.................#..#.............................................#....
        .....#......................#.......................................#.............................................#....#..........
        ...#.....................................................#......#...#.......#....#..............................#....#............
        ......#.....#.....#...........#...#................#...........................................#..................................
        ...................................#...............#......................................................#.......................
        ..............................#...#........................................................#.#.............#......................
        ......#.......#............#..#......................#..#.....#..................#......#.........................................
        #......#....#.......#....................#.....#.#............................................................................#...
        .#....#...................................#.................#....................#........................................#.......
        ............................................#...................................#.......#..............#.........................#
        ............##.........#..............................................................................#.........#.................
        ##.................................................#.......................#.#.....#..............................................
        ...........................#..........#...#.#.........................#.................................##.....#..................
        .............#..........#........................................#............#............#.....................................#
        .....................................................#.................................................#..........................
        .....#........................................#.............................#...#.....................#...........................
        .......#..................................#...........#.......#.....#........................................#.......#............
        .............#.......................#......................#.....#.......#..................................#..#........#........
        .......................................................#......#...............#.........#.............#............#..............
        ....#...............................#.#.....................#.................................................................#..#
        ...........................#........#..........................................#........................................#.........
        ....#.............................................................................................................................
        .##........#.......#..................#.#....#.............................................................#.##...................
        .#..#.......................##........................................................#...............................#...........
        .....#.#..............#...........................................#...............................................................
        .....#.#............................#.............................................................................................
        ......................#............................#....#............................................................#............
        .......#.......................................................................#..................#...##..........................
        ...............#...................................................#.....................................#...............#.#......
        ....#..........#.......#..#................................#......................................................................
        #......##..................................................................#...#........................#.........................
        ..................................#........................................................................#...........#......#...
        .#....................#....#..................................#..#..................#.#.......................#...................
        ......#..#................................................................................................##......................
        .....##........#..#.......................#.........#............#....#...........................................................
        ...............#...........#.................#...........#.........#.......................#.........#........................#...
        ............................................................................................#..#..................................
        ..........................................#.............#..#...............#.............................#.#......#.............#.
        ......................#............#..........#............................................................#...#................#.
        ...........#...................#..................................................................................................
        .......#........................#.................................................................#.................#.............
        #...##................#......................................................................#................................#...
        ...#.....#.......................#...#..............#....................#.........#.........#....................................
        ....#.....................................#.............................................................................#.........
        .........#..............................................................................#..............#..........................
        ...................................#.#...............#........................................................................##..
        .........#............#..............#..........................................................................#...#.............
        .....#.......................#..#....#.#....................#..........................................#..........................
        .......................................#........#.........#.....................#.............#...........#...............#.......
        ................#.................................................................................................................
        .......#....................................#..................#...........#.....#.........................#......................
        ...................#................................................................#...............#................#............
        ..........#.......................#......................#...........#..#........#....#.........................#.................
        ...................#........................#.......#................................................#............................
        .......................#......................................................#...........#.......#...................#...........
        ........#..........#........#......#......................#......................................#...............#................
        ...........................................................#...#..................................................................
        .......................#......................#............#..#....#...#............................#.............................
        .#.#...............#..........#..........##........#..............................................................................
        ##.........#....................#...................#.........#......................##..................#...............#........
        .#......................#...#...#......................#............#......................#.................#..................#.
        #..............................#......................................#.........#.#...............................................
        ...........#....#......#.......#..........................#..........................................#......#............#..#.....
        ................................................................................................#.......#.........................
        ....#..................................#..........................#.................................#...#...#.....................
        .......................#.#..#.............................#.#...........................#......#..........#.......................
        ...##.......................................#..................#....................#.............................................
        ...#.......#........................#..........##.....#............#......................#.....................................#.
        ......#..............#.............................#.............................................#.............................#..
        #...........................................#.......#....#.#..........#........#............#.......................#.......#.....
        ..................#.......#............#.....#.............................................................#......................
        .#.....................................................................................#...................................#......
        ...........#.........#.#.................#..........................#............................................#.......##.......
        .......................#......#.................................................#........................#.................#......
        ..................#........................................................#................................................#....#
        ...............................#.......#....#.........#..........#.....#.......................................#..#...............
        ......##................##...#....#...#...#............................................................................#..........
        .......................#............#...................................#....#.......#.............................#..............
        ..............................#.........................................................#........#.............#..................
        ........................#............................................#..................#.....#...................#...............
        ............#......#...............................#.............................................................................#
        .#.........#.........#.........#.......#.#..#...#...............................#.......#.........#..........................#....
        ........................#.................................................#....................................##......#..........
        ....#.......#.....................##...#..........................................................................................
        .................................#.......................................#.......................#.#......#.......................
        .#.............#..................#...........................#.................#...........................................#.....
        .....#.........#................#..........#..#..........#......................#...#......................#....#.................
        .................#......#.....................................................................#...................................
        ......................#.......................................................#..#......#..............#..#..#..........#.........
        ...............................#.........#........#..................#.#.........#.#.#........#..#.........#....##...#............
        """;
}