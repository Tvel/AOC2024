namespace AOC2024;

public class Day06
{
    [Theory]
    [InlineData(Inputs.Sample, 41)]
    [InlineData(Inputs.Input, 5409)]
    public void Part1(string inputString, long expected)
    {
        char[][] map = inputString.Split(Environment.NewLine).Select(x => x.ToCharArray()).ToArray();
        (int x, int y)[] directions =
        [
            (-1, 0), //up
            (0, 1), //right
            (1, 0), //down
            (0, -1), //left
        ];

        (int x, int y, int directionIndex) guard = (-1, -1, 0);
        for (int x = 0; x < map.Length; x++)
        {
            char[] row = map[x];
            int y = row.AsSpan().IndexOf('^');
            if (y is -1) continue;
            guard = (x, y, 0);
            row[y] = 'X';
            break;
        }

        bool walk = true;
        while (walk)
        {
            //check if we can walk forward
            int newX = guard.x + directions[guard.directionIndex].x;
            int newY = guard.y + directions[guard.directionIndex].y;
            if (newX < 0 || newY < 0 || newX >= map.Length || newY >= map[0].Length)
            {
                walk = false;
                break;
            }

            //check if we have to turn right
            if (map[newX][newY] is '#')
            {
                guard.directionIndex = (guard.directionIndex + 1) % directions.Length;
            }
            else
            {
                map[newX][newY] = 'X';
                guard = (newX, newY, guard.directionIndex);
            }
        }

        int result = map.Sum(x => x.Count(y => y is 'X'));

        Assert.Equal(expected, result);
    }

    [Theory]
    [InlineData(Inputs.Sample, 6)]
    [InlineData(Inputs.Input, 5409)]
    public void Part2Wrong2(string inputString, long expected)
    {
        char[][] map = inputString.Split(Environment.NewLine).Select(x => x.ToCharArray()).ToArray();
        (int x, int y)[] directions =
        [
            (-1, 0), //up
            (0, 1), //right
            (1, 0), //down
            (0, -1), //left
        ];

        (int x, int y, int directionIndex) guard = (-1, -1, 0);
        for (int x = 0; x < map.Length; x++)
        {
            char[] row = map[x];
            int y = row.AsSpan().IndexOf('^');
            if (y is -1) continue;
            guard = (x, y, 0);
            row[y] = 'X';
            break;
        }
        (int x, int y, int directionIndex) startGuard = guard;

        List<Func<bool>> tests = [];
        bool walk = true;
        while (walk)
        {
            //check if we can walk forward
            int newX = guard.x + directions[guard.directionIndex].x;
            int newY = guard.y + directions[guard.directionIndex].y;
            if (newX < 0 || newY < 0 || newX >= map.Length || newY >= map[0].Length)
            {
                walk = false;
                break;
            }

            //check if we have to turn right
            if (map[newX][newY] is '#')
            {
                guard.directionIndex = (guard.directionIndex + 1) % directions.Length;
            }
            else
            {
                //add to run
                var g = (guard.x, guard.y, guard.directionIndex);
                tests.Add(() => TestLoop(map, g, directions, (newX, newY)));

                guard = (newX, newY, guard.directionIndex);
            }
        }

        int loopCount = 0;
        Parallel.ForEach(tests, (func => { if(func()) Interlocked.Increment(ref loopCount); }));

        Assert.Equal(expected, loopCount);
    }

    bool TestLoop(char[][] map, (int x, int y, int directionIndex) startGuard, (int x, int y)[] directions, (int x, int y) obstacle)
    {
        var guard = startGuard;
        int count = 0;
        bool walk = true;
        bool loop = false;
        while (walk)
        {
            //check if we can walk forward
            int newX = guard.x + directions[guard.directionIndex].x;
            int newY = guard.y + directions[guard.directionIndex].y;
            if (newX < 0 || newY < 0 || newX >= map.Length || newY >= map[0].Length)
            {
                walk = false;
                break;
            }

            //check if we have to turn right
            if (map[newX][newY] is '#' || (newX, newY) == obstacle)
            {
                guard.directionIndex = (guard.directionIndex + 1) % directions.Length;
            }
            else
            {
                guard = (newX, newY, guard.directionIndex);
                if (startGuard == guard)
                {
                    walk = false;
                    loop = true;
                }

                count++;
                if (count > 100000) return true;
            }
        }
        return loop;
    }

}

file class Inputs
{
    public const string Sample =
        """
        ....#.....
        .........#
        ..........
        ..#.......
        .......#..
        ..........
        .#..^.....
        ........#.
        #.........
        ......#...
        """;
    //  0123456789
    public const string Input =
        """
        ..#.........#...#......#...........#.#...#............#...#.........#....#......................#......#..........................
        ...........#....#.............#.....................................#............................................#.....#..........
        .................#.........#.......#.......#..#............#.........#.........#............................................#.....
        ......#................................#.........................................#................................................
        #...............................##......#.#...........................#....................#...#...............#.................#
        .............#......#...........................................#..............#..........#..............#........................
        ...#...................#..............#........#.......#..........#.........................#.#.....#.....#.......................
        #.#...#.............................#.................................................#..............#............#...............
        .............................#.......#.............#......#...............#.....#.................................................
        ....................................#.....................................#.................#........#..........#.#..#...........#
        ......................#......#...............................#.................#.......#......................#.......#...........
        ...#..............#....................#............#...........##..#.....................................................#.......
        ....#.........#...................................#................................................#..........................#...
        ..............#.....#.................................................................#..#.....##.......#.........................
        .........#....#...........##..........................................#......#.....................#..........#.......#...........
        ..#....#..........#.................................................................#....#............#............#........#.....
        ............#.#....#...........#.............#...........#..................#.....#.................................#.......#.....
        ..........#.......#............................#........#...........#.......#...#....#........#.............##.#............#.....
        ...................#.........#....#.....................................................................#.#..........#............
        .#...#.#..................#...............................................#...........................#......................#....
        .........#..............#.........#.......#.#......##..................#......#...#..#...........#.....................#..........
        ...............................#.............#..#......#............#..........#......................#..........#.............#..
        ..........#.....#..........................#..................................................#.#..#.....#........................
        ............#..##.................................#....................#.....#.......................................#............
        ......................#.#...................#......#..............................................................#...............
        .......#.............................................................................#............................................
        ........#.................#....................................................#.......................................#....##.#..
        ..................#........................#......#..##....#.........#...##..#....................................#...............
        .............#..............................................................................##...#......#.................#.......
        ..................................#.#.............................................................................#...............
        ...........#.................................#.......................................................................#......#.....
        .....#............................................................#................................................#..............
        .....#...........#.#..........#..............#..........................#.................................................#.......
        ....#........#...#..........#..#..........................................................................#.......................
        .........................................................................#.....#.......................................#....#.....
        ...............#...#..#.....#.......................#.................#........#..........##....................................#.
        .......................#....#...#..................#..................#.....................................#.............#.......
        ...........#..#...#..............................................^........#........................#......................#.......
        .............................................#.................................................................................#..
        ......#...#.........#.....................................#...............................................#..#....#.......#.......
        ...#......................................................#.................#..#.............................................#....
        .....#......................#.......................................#.............................................#....#..........
        ...#.....................................................#......#...#.......#....#..............................#....#............
        ......#.....#.....#...........#...#................#...........................................#..................................
        ...................................#...............#......................................................#.......................
        ..............................#...#........................................................#.#.............#......................
        ......#.......#............#..#......................#..#.....#..................#......#.........................................
        #......#....#.......#....................#.....#.#............................................................................#...
        .#....#...................................#.................#....................#........................................#.......
        ............................................#...................................#.......#..............#.........................#
        ............##.........#..............................................................................#.........#.................
        ##.................................................#.......................#.#.....#..............................................
        ...........................#..........#...#.#.........................#.................................##.....#..................
        .............#..........#........................................#............#............#.....................................#
        .....................................................#.................................................#..........................
        .....#........................................#.............................#...#.....................#...........................
        .......#..................................#...........#.......#.....#........................................#.......#............
        .............#.......................#......................#.....#.......#..................................#..#........#........
        .......................................................#......#...............#.........#.............#............#..............
        ....#...............................#.#.....................#.................................................................#..#
        ...........................#........#..........................................#........................................#.........
        ....#.............................................................................................................................
        .##........#.......#..................#.#....#.............................................................#.##...................
        .#..#.......................##........................................................#...............................#...........
        .....#.#..............#...........................................#...............................................................
        .....#.#............................#.............................................................................................
        ......................#............................#....#............................................................#............
        .......#.......................................................................#..................#...##..........................
        ...............#...................................................#.....................................#...............#.#......
        ....#..........#.......#..#................................#......................................................................
        #......##..................................................................#...#........................#.........................
        ..................................#........................................................................#...........#......#...
        .#....................#....#..................................#..#..................#.#.......................#...................
        ......#..#................................................................................................##......................
        .....##........#..#.......................#.........#............#....#...........................................................
        ...............#...........#.................#...........#.........#.......................#.........#........................#...
        ............................................................................................#..#..................................
        ..........................................#.............#..#...............#.............................#.#......#.............#.
        ......................#............#..........#............................................................#...#................#.
        ...........#...................#..................................................................................................
        .......#........................#.................................................................#.................#.............
        #...##................#......................................................................#................................#...
        ...#.....#.......................#...#..............#....................#.........#.........#....................................
        ....#.....................................#.............................................................................#.........
        .........#..............................................................................#..............#..........................
        ...................................#.#...............#........................................................................##..
        .........#............#..............#..........................................................................#...#.............
        .....#.......................#..#....#.#....................#..........................................#..........................
        .......................................#........#.........#.....................#.............#...........#...............#.......
        ................#.................................................................................................................
        .......#....................................#..................#...........#.....#.........................#......................
        ...................#................................................................#...............#................#............
        ..........#.......................#......................#...........#..#........#....#.........................#.................
        ...................#........................#.......#................................................#............................
        .......................#......................................................#...........#.......#...................#...........
        ........#..........#........#......#......................#......................................#...............#................
        ...........................................................#...#..................................................................
        .......................#......................#............#..#....#...#............................#.............................
        .#.#...............#..........#..........##........#..............................................................................
        ##.........#....................#...................#.........#......................##..................#...............#........
        .#......................#...#...#......................#............#......................#.................#..................#.
        #..............................#......................................#.........#.#...............................................
        ...........#....#......#.......#..........................#..........................................#......#............#..#.....
        ................................................................................................#.......#.........................
        ....#..................................#..........................#.................................#...#...#.....................
        .......................#.#..#.............................#.#...........................#......#..........#.......................
        ...##.......................................#..................#....................#.............................................
        ...#.......#........................#..........##.....#............#......................#.....................................#.
        ......#..............#.............................#.............................................#.............................#..
        #...........................................#.......#....#.#..........#........#............#.......................#.......#.....
        ..................#.......#............#.....#.............................................................#......................
        .#.....................................................................................#...................................#......
        ...........#.........#.#.................#..........................#............................................#.......##.......
        .......................#......#.................................................#........................#.................#......
        ..................#........................................................#................................................#....#
        ...............................#.......#....#.........#..........#.....#.......................................#..#...............
        ......##................##...#....#...#...#............................................................................#..........
        .......................#............#...................................#....#.......#.............................#..............
        ..............................#.........................................................#........#.............#..................
        ........................#............................................#..................#.....#...................#...............
        ............#......#...............................#.............................................................................#
        .#.........#.........#.........#.......#.#..#...#...............................#.......#.........#..........................#....
        ........................#.................................................#....................................##......#..........
        ....#.......#.....................##...#..........................................................................................
        .................................#.......................................#.......................#.#......#.......................
        .#.............#..................#...........................#.................#...........................................#.....
        .....#.........#................#..........#..#..........#......................#...#......................#....#.................
        .................#......#.....................................................................#...................................
        ......................#.......................................................#..#......#..............#..#..#..........#.........
        ...............................#.........#........#..................#.#.........#.#.#........#..#.........#....##...#............
        """;
}